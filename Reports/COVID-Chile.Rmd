---
title: COVID_Chile
output: html_document
---
```{r setup, include=FALSE}
library(tidyverse)
library(dplyr)
library(grid)
library(gridExtra)
library(sf)
library(raster)
library(flextable)
library(scales)
#library(rnaturalearth)
#library(ggmap)
#ggmap
#register_google(key = "xxx", write = TRUE)

currentDate <- Sys.Date()
currentDate <- as.Date(currentDate, format="%Y-%m-%d")
currentDate<- format(currentDate, "%d/%m/%Y")
```


```{r DB , include=FALSE}
url5 <- "https://raw.githubusercontent.com/MinCiencia/Datos-COVID19/master/output/producto5/TotalesNacionales.csv"
#Destino<- paste("COVID-19_Chile-DP5_",currentDate,".csv",sep="")
#download.file(url5, Destino)
chile5 <- read.csv(url5, stringsAsFactors = FALSE, check.names = F)%>% 
  gather(key = fecha, value = "Value", 
                 -Fecha, na.rm = TRUE) %>%
  rename(Variable = "Fecha" , Fecha = "fecha")
chile5$Fecha <- as.Date(chile5$Fecha)

url19 <- "https://raw.githubusercontent.com/MinCiencia/Datos-COVID19/master/output/producto19/CasosActivosPorComuna.csv"

chile19 <- read.csv(url19, stringsAsFactors = FALSE, check.names = F) %>%
  gather(key = "Fecha", value = "Value", -Region , -`Codigo region`, -Comuna, -`Codigo comuna` ,-Poblacion, na.rm = TRUE) %>% rename(cod_comuna=`Codigo comuna`, codigo_region=`Codigo region`)
chile19$Fecha <- as.Date(chile19$Fecha)

url33 <- "https://raw.githubusercontent.com/MinCiencia/Datos-COVID19/master/output/producto33/IndiceDeMovilidad-IM.csv"
chile33 <- read.csv(url33, stringsAsFactors = FALSE, check.names = F) %>%
  gather(key = "Fecha", value = "Value",-Region, -`Codigo region`,-Comuna ,-`Codigo comuna`, -Superficie_km2, -Poblacion, na.rm = TRUE) %>%
  rename(codigo_region="Codigo region", cod_comuna="Codigo comuna", comuna_residencia="Comuna")


url38 <- "https://raw.githubusercontent.com/MinCiencia/Datos-COVID19/master/output/producto38/CasosFallecidosPorComuna.csv"
chile38 <- read.csv(url38, stringsAsFactors = FALSE, check.names = F) %>%
  gather(key = "Fecha", value = "Value",-Region, -`Codigo region`,-Comuna ,-`Codigo comuna`, -Poblacion, na.rm = TRUE) %>%
  rename(codigo_region="Codigo region", cod_comuna="Codigo comuna")


url54 <- "https://raw.githubusercontent.com/MinCiencia/Datos-COVID19/master/output/producto54/r.provincial.csv"
chile54 <- read.csv(url54, stringsAsFactors = FALSE, check.names = F) %>%
  gather(key = "Variable", value = "Value",-fecha ,-Region,
                 -`Codigo region`, -Provincia, -`Codigo provincia`, na.rm = TRUE) %>%
  rename(codregion ="Codigo region", cod_prov="Codigo provincia", Fecha="fecha")

url58 <- "https://raw.githubusercontent.com/MinCiencia/Datos-COVID19/master/output/producto58/Camas_UCI_diarias.csv"
chile58 <- read.csv(url58, stringsAsFactors = FALSE, check.names = F) %>%
  gather(key = "Fecha", value = "Value",-Region, -Serie,na.rm = TRUE) 

url74<- "https://raw.githubusercontent.com/MinCiencia/Datos-COVID19/master/output/producto74/paso_a_paso.csv"
chile74 <- read.csv(url74, stringsAsFactors = FALSE, check.names = F )%>%
  gather(key = "Fecha", value = "Value",-codigo_region ,-region_residencia,
                 -codigo_comuna, -comuna_residencia, -zona, na.rm = TRUE)  %>%
  rename(cod_comuna = "codigo_comuna")
chile74$Fecha <- as.Date(chile74$Fecha)

#chile54$Fecha <- as.Date(chile54$Fecha)

Comunas.Chile <- st_read("Comunas/comunas.shp") 
Regiones.Chile <- st_read("Regiones/Regional.shp") 
Provincias.Chile <- st_read("Provincias/Provincias.shp") 
Comunas.Chile  <-Comunas.Chile[c("Provincia","cod_comuna")]
Provincias.Chile  <-Provincias.Chile[c("geometry","cod_prov")]
Regiones.Chile  <-Regiones.Chile[c("geometry","codregion")]
```

```{r Resumen-Region-set, include=FALSE}

Reg.sel<-c("13") ## Seleccionar region para informe

# Activos
chile19_map <- chile19 %>%group_by(cod_comuna) %>% filter(Fecha==max(Fecha)) 
chile19_map <- merge(chile19_map, Comunas.Chile)
chile19_map_R <- chile19_map %>% filter(codigo_region==Reg.sel)



# Fase
chile74_map <- chile74 %>%group_by(cod_comuna) %>% filter(Fecha==max(Fecha)) %>%
  summarise(Value=min(Value), cod_comuna=unique(cod_comuna),
            codigo_region=unique(codigo_region), region_residencia=unique(region_residencia),
            comuna_residencia=unique(comuna_residencia), Fecha=unique(Fecha))
chile74_map <- merge(chile74_map, Comunas.Chile)
chile74_map_R <- chile74_map %>% filter(codigo_region==Reg.sel)
chile74_map_R$Value <- as.factor(chile74_map_R$Value)

# Indice Movilidad
chile33_R <- chile33 %>%group_by(cod_comuna) %>% filter(Fecha==max(Fecha))%>% filter(codigo_region==Reg.sel) %>% mutate(Value = sprintf("%0.2f", Value)) %>% mutate(Label= paste(comuna_residencia, Value , sep = " - "))
chile33_map <- merge(chile33_R, Comunas.Chile)
#chile33_map_R <- chile33_map  %>%
#  group_by(Provincia) %>% summarise(Value=sum(Value), geometry=st_union(geometry))
#chile33_map_R <- chile33_map_R


# R (reproduccion)
chile54_R <- chile54 %>% group_by(cod_prov) %>% filter(Fecha==max(Fecha)) %>% filter(Variable=="r.estimado")
chile54_map <- merge(chile54_R, Provincias.Chile)
chile54_map_R <- chile54_map %>% filter(codregion==Reg.sel)
chile54_map_R <- chile54_map_R %>% mutate(Value = sprintf("%0.2f", Value))

# Camas Criticas
#chile58_R <- chile58 %>% filter(Fecha==max(Fecha)) %>% filter(codregion==Reg.sel)



```

```{r Resumen-Map-Set, include=FALSE}
map.format <-   theme_bw()+
    theme(axis.title.x=element_blank(),
          axis.title.y = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        legend.position = "top")


group.colors <- c("1" = "red4", "2" = "orange4", "3" ="yellow3", "4" = "blue4")


Region_Map_Fase <- ggplot() + 
  geom_sf(data= chile74_map_R, aes(geometry= geometry, fill = Value)) +
 scale_fill_manual(values=group.colors, name = "Fase") +
    geom_sf(data= chile54_map_R, aes(geometry= geometry), color="white", alpha=0.1) +
  map.format

Region_Map_Act <- ggplot()+
  geom_sf(data=chile19_map_R, aes(geometry=geometry, fill=Value))+
  scale_fill_viridis_c(option = 'D', name= "Casos Activos")+
  geom_sf(data= chile54_map_R, aes(geometry= geometry), color="white", alpha=0.1) +
   geom_sf_text(data= chile54_map_R, aes(geometry= geometry, label = Value), colour="white")+
  labs(caption = "DP54  - N° de Reproduccion Efectivo - DP19 - Casos Activos") +
  map.format 

Region_Fase  <-chile74_map_R[c("Value","comuna_residencia")]
Region_Fase<- Region_Fase %>% rename(Fase="Value")
Region_Fase <- merge(Region_Fase, chile33_R)

MaxComunaC<-  chile19_map_R %>% filter(Poblacion == max(Poblacion)) %>% pull(Poblacion) %>% as.numeric() %>% comma()
MaxComuna<-  chile19_map_R %>% filter(Poblacion == max(Poblacion)) %>% pull(Comuna)
Region <- Region_Fase %>% filter(Poblacion == max(Poblacion)) %>% pull(Region)


Region_Fase_Comunas <- ggplot(data= Region_Fase, aes(comuna_residencia, Fase, fill=Fase))+
  geom_tile() + geom_text(data =  Region_Fase, aes(comuna_residencia, Fase, label=comuna_residencia), colour="white", size=2, fontface="bold" , check_overlap=TRUE) + 
  scale_fill_manual(values=group.colors, name = "Fase") + map.format + coord_flip()
```

# Region **`r Region`**  COVID-19 Chile `r currentDate`

La comuna con el mayor numero de casos activos es **`r MaxComuna`** con un total de `r MaxComunaC`. 

```{r Resumen-Region, echo=FALSE, fig.align='center'}

grid.arrange(Region_Map_Act, Region_Fase_Comunas, ncol=2)

```

```{r Resumen-Region-set_2, include=FALSE}

Reg.sel.2<-c("5") ## Seleccionar region para informe

# Activos
chile19_map_R_2 <- chile19_map %>% filter(codigo_region==Reg.sel.2)%>%
  filter(Comuna!='Juan Fernandez') %>% filter(Comuna!='Isla de Pascua')

# Indice Movilidad
chile33_R_2 <- chile33 %>%group_by(cod_comuna) %>% filter(Fecha==max(Fecha))%>% filter(codigo_region==Reg.sel.2)%>%
  filter(comuna_residencia!='Juan Fernandez') %>% filter(comuna_residencia!='Isla de Pascua') %>% mutate(Value = sprintf("%0.2f", Value)) %>% mutate(Label= paste(comuna_residencia, Value , sep = " - "))


# Fase
chile74_map_R_2 <- chile74_map %>% filter(codigo_region==Reg.sel.2)%>%
  filter(comuna_residencia!='Juan Fernández') %>% filter(comuna_residencia!='Isla de Pascua')
chile74_map_R_2$Value <- as.factor(chile74_map_R_2$Value)


# R (reproduccion)
chile54_R_2 <- chile54 %>% group_by(cod_prov) %>% filter(Fecha==max(Fecha)) %>% filter(Variable=="r.estimado") %>% filter(codregion==Reg.sel.2) %>% mutate(Value = sprintf("%0.2f", Value))
chile54_map_R_2 <- merge(chile54_R_2, Provincias.Chile)
chile54_map_R_2 <- chile54_map_R_2 
# Camas Criticas
#chile58_R <- chile58 %>% filter(Fecha==max(Fecha)) %>% filter(codregion==Reg.sel)

```


```{r Resumen-Map-Set_2, include=FALSE}

Map_Prov_R_2 <- chile74_map_R_2 %>% group_by(Provincia) %>% summarise(geometry=st_union(geometry))

Map_Prov_R_2 <- merge(Map_Prov_R_2, chile54_R_2)

Region_2_Map_Act <- ggplot()+
  geom_sf(data=chile19_map_R_2, aes(geometry=geometry, fill=Value))+
  scale_fill_viridis_c(option = 'D', name= "Casos Activos")+
  geom_sf(data= Map_Prov_R_2, aes(geometry= geometry), color="white", alpha=0.1) +
  geom_sf_text(data= Map_Prov_R_2, aes(geometry= geometry, label = Value), colour="white")+
  labs(caption = "DP54  - N° de Reproduccion Efectivo - DP19 - Casos Activos") +
  map.format 




Region_Fase_2 <- chile74 %>% group_by(cod_comuna) %>% filter(Fecha==max(Fecha))  %>% filter(codigo_region==Reg.sel.2) 
Region_Fase_2  <-Region_Fase_2[c("Value","comuna_residencia")]

Region_Fase_2<- Region_Fase_2 %>% rename(Fase="Value")
Region_Fase_2$Fase <- as.factor(Region_Fase_2$Fase)
Region_Fase_2 <- merge(Region_Fase_2, chile33_R_2)

MaxComunaC_2<-  chile19_map_R_2 %>% filter(Poblacion == max(Poblacion)) %>% pull(Poblacion) %>% as.numeric() %>% comma()
MaxComuna_2<-  chile19_map_R_2 %>% filter(Poblacion == max(Poblacion)) %>% pull(Comuna)
Region_2 <- Region_Fase_2 %>% filter(Poblacion == max(Poblacion)) %>% pull(Region)


Region_2_Fase_Comunas <- ggplot(data= Region_Fase_2, aes(comuna_residencia, Fase, fill=Fase))+
  geom_tile() + geom_text(data =  Region_Fase_2, aes(comuna_residencia, Fase, label=comuna_residencia), colour="white", size=2, fontface="bold" , check_overlap=TRUE) + 
  scale_fill_manual(values=group.colors, name = "Fase") + map.format + coord_flip()
```

# Region **`r Region_2`**  COVID-19 Chile `r currentDate`

La comuna con el mayor numero de casos activos es **`r MaxComuna_2`** con un total de `r MaxComunaC_2`. 

```{r Resumen-Region_2, echo=FALSE, fig.align='center'}

grid.arrange(Region_2_Map_Act, Region_2_Fase_Comunas, ncol=2)

```




```{r Resumen-Region-set-3, include=FALSE}

Reg.sel.3<-c("9") ## Seleccionar region para informe

# Activos

chile19_map_R_3 <- chile19_map %>% filter(codigo_region==Reg.sel.3)



# Fase
chile74_map_R_3 <- chile74_map %>% filter(codigo_region==Reg.sel.3)
chile74_map_R_3$Value <- as.factor(chile74_map_R_3$Value)

# Indice Movilidad


# R (reproduccion)
chile54_R <- chile54 %>% group_by(cod_prov) %>% filter(Fecha==max(Fecha)) %>% filter(Variable=="r.estimado")
chile54_map <- merge(chile54_R, Provincias.Chile)
chile54_map_R_3 <- chile54_map %>% filter(codregion==Reg.sel.3)
chile54_map_R_3 <- chile54_map_R_3 %>% mutate(Value = sprintf("%0.2f", Value))

# Camas Criticas
#chile58_R <- chile58 %>% filter(Fecha==max(Fecha)) %>% filter(codregion==Reg.sel)



```

```{r Resumen-Map-Set-3, include=FALSE}


Region_3_Map_Act <- ggplot()+
  geom_sf(data=chile19_map_R_3, aes(geometry=geometry, fill=Value))+
  scale_fill_viridis_c(option = 'D', name= "Casos Activos")+
  geom_sf(data= chile54_map_R_3, aes(geometry= geometry), color="white", alpha=0.1) +
   geom_sf_text(data= chile54_map_R_3, aes(geometry= geometry, label = Value), colour="white")+
  labs(caption = "DP54  - N° de Reproduccion Efectivo - DP19 - Casos Activos") +
  map.format 

Region_3_Fase  <-chile74_map_R_3[c("Value","comuna_residencia")]
Region_3_Fase<- Region_3_Fase %>% rename(Fase="Value")

MaxComunaC_3<-  chile19_map_R_3 %>% filter(Poblacion == max(Poblacion)) %>% pull(Poblacion) %>% as.numeric() %>% comma()
MaxComuna_3<-  chile19_map_R_3 %>% filter(Poblacion == max(Poblacion)) %>% pull(Comuna)
Region_3 <-  chile19_map_R_3 %>% filter(Value == max(Value)) %>% pull(Region)


Region_3_Fase_Comunas <- ggplot(data= Region_3_Fase, aes(comuna_residencia, Fase, fill=Fase))+
  geom_tile() + geom_text(data =  Region_3_Fase, aes(comuna_residencia, Fase, label=comuna_residencia), colour="white", size=2, fontface="bold" , check_overlap=TRUE) + 
  scale_fill_manual(values=group.colors, name = "Fase") + map.format + coord_flip()
```

# Region **`r Region_3`**  COVID-19 Chile `r currentDate`

La comuna con el mayor numero de casos activos es **`r MaxComuna_3`** con un total de `r MaxComunaC_3`. 

```{r Resumen-Region_3, echo=FALSE, fig.align='center'}

grid.arrange(Region_3_Map_Act, Region_3_Fase_Comunas, ncol=2)

```





```{r plot-DP-5-set , echo=FALSE, fig.align='center' , fig.cap="DP5 - Totales Nacionales Diarios"}

g1<- chile5 %>% filter(Variable=="Casos totales")  %>%
  drop_na() %>%
  ggplot( aes(x=Fecha, y=Value ))+
  geom_line()+
  ggtitle("Casos Totales") + 
  ylab("N° de Personas") +
  scale_y_continuous(labels = scales::comma)+
  theme(plot.title = element_text(hjust = 0.5))

g2<- chile5 %>% filter(Variable=="Fallecidos")  %>%
  drop_na() %>%
  ggplot( aes(x=Fecha, y=Value))+
  geom_line()+
  ggtitle("Fallecidos") + 
  ylab("N° de Personas") +
  scale_y_continuous(labels = scales::comma)+
  theme(plot.title = element_text(hjust = 0.5))

g3<- chile5 %>% filter(Variable=="Casos activos")  %>%
  drop_na() %>%
  ggplot( aes(x=Fecha, y=Value))+
  geom_line()+
  ggtitle("Casos Activos") + 
  ylab("N° de Personas") +
  scale_y_continuous(labels = scales::comma)+
  theme(plot.title = element_text(hjust = 0.5))

g4<- chile5 %>% filter(Variable=="Casos nuevos totales")  %>%
  drop_na() %>%
  ggplot( aes(x=Fecha, y=Value))+
  geom_line()+
  ggtitle("Casos Nuevos") + 
  ylab("N° de Personas") +
  scale_y_continuous(labels = scales::comma)+
  theme(plot.title = element_text(hjust = 0.5))

```




```{r plot-DP-5 , echo=FALSE, fig.align='center' , fig.cap="DP5 - Totales Nacionales Diarios"}
grid.arrange(g1, g2, g3, g4)
```

Datos obtenidos de [Ministerio Ciencia - Datos COVID-19](https://github.com/MinCiencia/Datos-COVID19/) , [Biblioteca del Congreso Nacional de Chile - Mapas Vectoriales](https://www.bcn.cl/siit/mapas_vectoriales), [Microdatos Censo 2017 : Manzana](https://geoine-ine-chile.opendata.arcgis.com/datasets/54e0c40680054efaabeb9d53b09e1e7a_0?geometry=-177.461%2C-58.764%2C0.429%2C-11.429) y [Plan Paso a Paso](https://www.gob.cl/pasoapaso/) 

<img src="rlogo.png" width="22" height="20" /> [R Core Team (2020)](https://www.R-project.org/) R: A language and environment for statistical computing. R  Foundation for Statistical Computing, Vienna, Austria